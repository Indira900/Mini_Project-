{% extends "base.html" %}

{% block head %}
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhseINkfSgoIHPqNkRHE2pRESqmAudayI1AI=" crossorigin=""/>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.style.css') }}">
{% endblock %}

{% block title %}Find a Clinic - IVF Journey Tracker{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4 text-center text-success">
    <i class="fas fa-hospital"></i> Find IVF Clinics
  </h2>

  <form method="POST" action="{{ url_for('find_clinic') }}" class="mb-4">
    <div class="input-group">
      <input type="text" class="form-control" name="location"
             placeholder="Enter city or state (e.g., Mumbai, Karnataka)">
      <button class="btn btn-success" type="submit">Search</button>
    </div>
    <small class="text-muted">You can search by city, state, or clinic name.</small>
  </form>

  <!-- Map Toggle -->
  <div class="d-flex justify-content-center mb-4">
    <div class="btn-group" role="group" aria-label="View toggle">
      <input type="radio" class="btn-check" name="viewToggle" id="listView" autocomplete="off" checked>
      <label class="btn btn-outline-success" for="listView">
        <i class="fas fa-list"></i> List View
      </label>
      <input type="radio" class="btn-check" name="viewToggle" id="mapView" autocomplete="off">
      <label class="btn btn-outline-success" for="mapView">
        <i class="fas fa-map-marked-alt"></i> Map View
      </label>
    </div>
  </div>

  <!-- Map Container -->
  <div id="mapContainer" class="d-none mb-4">
    <div id="clinicMap" style="height: 500px; width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
  </div>

  {% if not query %}
    <div class="alert alert-info">
      <h6><i class="fas fa-info-circle me-2"></i>Available Clinics</h6>
      <p>We have <strong>{{ total_clinics|default(0) }}</strong> IVF clinics available across India. Search above to find clinics in your area, or browse all clinics below.</p>
    </div>

    <h5 class="mt-4 mb-3">Browse All Clinics</h5>
    <div class="row mt-3">
      {% for clinic in all_clinics %}
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h6 class="card-title fw-bold text-success">
                <i class="fas fa-hospital me-2"></i>{{ clinic.name }}
              </h6>
                <p class="card-text mb-2">
                  <i class="fas fa-map-marker-alt text-danger me-2"></i>
                  {{ clinic.address }}
                </p>
              {% if clinic.phone %}
                <p class="card-text mb-2">
                  <i class="fas fa-phone text-success me-2"></i>{{ clinic.phone }}
                </p>
              {% endif %}
              {% if clinic.contact_number %}
                <p class="card-text mb-2">
                  <i class="fas fa-mobile-alt text-success me-2"></i>{{ clinic.contact_number }}
                </p>
              {% endif %}
              {% if clinic.description %}
                <p class="card-text text-muted small mb-3">{{ clinic.description[:100] }}...</p>
              {% endif %}
              <div class="mt-auto">
                <a href="{{ url_for('clinic_detail', clinic_id=clinic.id) }}" class="btn btn-success btn-sm">
                  <i class="fas fa-info-circle me-2"></i>View Details
                </a>
                {% if clinic.website %}
                  <a href="{{ clinic.website }}" target="_blank" class="btn btn-outline-primary btn-sm ms-2">
                    <i class="fas fa-external-link-alt me-2"></i>Website
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if query %}
    <h5 class="mt-4">Search Results for "<strong>{{ query }}</strong>"</h5>

    {% if clinics %}
      <div class="row mt-3">
        {% for clinic in clinics %}
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-body d-flex flex-column">
                <h6 class="card-title fw-bold text-success">
                  <i class="fas fa-hospital me-2"></i>{{ clinic.name }}
                </h6>
                <p class="card-text mb-2">
                  <i class="fas fa-map-marker-alt text-danger me-2"></i>
                  {{ clinic.address }}
                </p>
                {% if clinic.phone %}
                  <p class="card-text mb-2">
                    <i class="fas fa-phone text-success me-2"></i>{{ clinic.phone }}
                  </p>
                {% endif %}
                {% if clinic.contact_number %}
                  <p class="card-text mb-2">
                    <i class="fas fa-mobile-alt text-success me-2"></i>{{ clinic.contact_number }}
                  </p>
                {% endif %}
                {% if clinic.description %}
                  <p class="card-text text-muted small mb-3">{{ clinic.description[:100] }}...</p>
                {% endif %}
                <div class="mt-auto">
                  <a href="{{ url_for('clinic_detail', clinic_id=clinic.id) }}" class="btn btn-success btn-sm">
                    <i class="fas fa-info-circle me-2"></i>View Details
                  </a>
                  {% if clinic.website %}
                    <a href="{{ clinic.website }}" target="_blank" class="btn btn-outline-primary btn-sm ms-2">
                      <i class="fas fa-external-link-alt me-2"></i>Website
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-danger mt-3">
        No clinics found matching your search criteria. Please try another location.
      </p>
    {% endif %}
  {% endif %}
</div>

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    var map = L.map('clinicMap').setView([20.5937, 78.9629], 5); // Center on India

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Clinic data from template
    var clinics = [
        {% if query and clinics %}
            {% for clinic in clinics %}
                {
                    id: {{ clinic.id }},
                    name: "{{ clinic.name|replace('"', '\\"') }}",
                    address: "{{ clinic.address|replace('"', '\\"') }}",
                    city: "{{ clinic.city }}",
                    state: "{{ clinic.state }}",
                    phone: "{{ clinic.phone or '' }}",
                    website: "{{ clinic.website or '' }}",
                    lat: {{ clinic.latitude|default(0) }},
                    lng: {{ clinic.longitude|default(0) }}
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        {% elif all_clinics %}
            {% for clinic in all_clinics %}
                {
                    id: {{ clinic.id }},
                    name: "{{ clinic.name|replace('"', '\\"') }}",
                    address: "{{ clinic.address|replace('"', '\\"') }}",
                    city: "{{ clinic.city }}",
                    state: "{{ clinic.state }}",
                    phone: "{{ clinic.phone or '' }}",
                    website: "{{ clinic.website or '' }}",
                    lat: {{ clinic.latitude|default(0) }},
                    lng: {{ clinic.longitude|default(0) }}
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        {% endif %}
    ];

    // Add markers for clinics
    clinics.forEach(function(clinic) {
        if (clinic.lat && clinic.lng) {
            var marker = L.marker([clinic.lat, clinic.lng]).addTo(map);

            var popupContent = `
                <div class="clinic-popup">
                    <h6 class="text-success mb-2">${clinic.name}</h6>
                    <p class="mb-1"><i class="fas fa-map-marker-alt text-danger me-1"></i>${clinic.address}</p>
                    ${clinic.phone ? `<p class="mb-1"><i class="fas fa-phone text-success me-1"></i>${clinic.phone}</p>` : ''}
                    <div class="mt-2">
                        <a href="/clinic/${clinic.id}" class="btn btn-success btn-sm">
                            <i class="fas fa-info-circle me-1"></i>View Details
                        </a>
                        ${clinic.website ? `<a href="${clinic.website}" target="_blank" class="btn btn-outline-primary btn-sm ms-1">
                            <i class="fas fa-external-link-alt me-1"></i>Website
                        </a>` : ''}
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
        }
    });

    // View toggle functionality
    const listViewBtn = document.getElementById('listView');
    const mapViewBtn = document.getElementById('mapView');
    const mapContainer = document.getElementById('mapContainer');
    const listContainer = document.querySelector('.row.mt-3') || document.querySelector('.row');

    function toggleView() {
        if (mapViewBtn.checked) {
            mapContainer.classList.remove('d-none');
            if (listContainer) listContainer.style.display = 'none';
            // Refresh map size
            setTimeout(() => map.invalidateSize(), 100);
        } else {
            mapContainer.classList.add('d-none');
            if (listContainer) listContainer.style.display = 'flex';
        }
    }

    listViewBtn.addEventListener('change', toggleView);
    mapViewBtn.addEventListener('change', toggleView);
});
</script>
{% endblock %}
