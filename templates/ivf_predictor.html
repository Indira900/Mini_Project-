{% extends "base.html" %}

{% block title %}IVF Success Predictor{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .prediction-card {
            transition: all 0.3s ease-in-out;
        }
        .prediction-result-box {
            border-left: 5px solid #0dcaf0;
            background-color: #f8f9fa;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header bg-gradient-primary text-white rounded p-4 shadow-sm">
                <h1 class="mb-2">
                    <i class="fas fa-chart-line me-3"></i>AI IVF Success Predictor
                </h1>
                <p class="mb-0 opacity-90">
                    Enter your details to get a personalized success probability based on our AI model.
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Prediction Form Column -->
        <div class="col-lg-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Your Medical & Lifestyle Data</h5>
                </div>
                <div class="card-body">
                    <form id="prediction-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="Age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="Age" value="{{ patient_data.age or 32 }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="BMI" class="form-label">BMI (Body Mass Index)</label>
                                <input type="number" step="0.1" class="form-control" id="BMI" value="{{ patient_data.bmi or 22.5 }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="AMH" class="form-label">AMH Level (ng/mL)</label>
                                <input type="number" step="0.1" class="form-control" id="AMH" value="{{ patient_data.amh_level or 2.5 }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="FSH" class="form-label">FSH Level (mIU/mL)</label>
                                <input type="number" step="0.1" class="form-control" id="FSH" value="{{ patient_data.fsh_level or 7.0 }}" required>
                            </div>
                            <!-- LH removed as it's not used in the model -->
                            <div class="col-md-6 mb-3">
                                <label for="Previous_IVF_Attempts" class="form-label">Previous IVF Attempts</label>
                                <input type="number" class="form-control" id="Previous_IVF_Attempts" value="{{ patient_data.previous_ivf_cycles or 0 }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="Stress_Level" class="form-label">Stress Level (1-5)</label>
                                <input type="number" class="form-control" id="Stress_Level" value="3" min="1" max="5" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="Sleep_Hours" class="form-label">Avg. Sleep (Hours)</label>
                                <input type="number" step="0.5" class="form-control" id="Sleep_Hours" value="7.5" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="Exercise_Min_per_Day" class="form-label">Avg. Exercise (Mins/Day)</label>
                                <input type="number" class="form-control" id="Exercise_Min_per_Day" value="30" required>
                            </div>
                        </div>
                        <button type="submit" id="predict-btn" class="btn btn-primary w-100 mt-3">
                            <i class="fas fa-cogs me-2"></i>Run AI Prediction
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Prediction Result Column -->
        <div class="col-lg-5">
            <div class="card shadow-sm prediction-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>AI Prediction Result</h5>
                </div>
                <div class="card-body text-center" id="result-container">
                    <p class="text-muted">Your personalized prediction will appear here.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.getElementById('prediction-form').addEventListener('submit', async function(event) {
    event.preventDefault();

    const predictBtn = document.getElementById('predict-btn');
    const resultContainer = document.getElementById('result-container');

    // --- Show loading state ---
    predictBtn.disabled = true;
    predictBtn.innerHTML = `<span class="spinner-border" role="status" aria-hidden="true"></span> Analyzing...`;
    resultContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

    // --- Client-side validation ---
    const inputIds = ["Age", "BMI", "AMH", "FSH", "Previous_IVF_Attempts", "Stress_Level", "Sleep_Hours", "Exercise_Min_per_Day"];
    for (const id of inputIds) {
        const inputElement = document.getElementById(id);
        if (!inputElement.value || isNaN(parseFloat(inputElement.value))) {
            resultContainer.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Please enter a valid number for "${inputElement.labels[0].textContent}".</div>`;
            predictBtn.disabled = false;
            predictBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Run AI Prediction';
            return; // Stop execution if validation fails
        }
    }

    // --- Collect data from the form ---
    const features = {
        "Age": parseInt(document.getElementById('Age').value),
        "BMI": parseFloat(document.getElementById('BMI').value),
        "AMH": parseFloat(document.getElementById('AMH').value),
        "FSH": parseFloat(document.getElementById('FSH').value),
        "Previous_IVF_Attempts": parseInt(document.getElementById('Previous_IVF_Attempts').value),
        "Stress_Level": parseInt(document.getElementById('Stress_Level').value),
        "Sleep_Hours": parseFloat(document.getElementById('Sleep_Hours').value),
        "Exercise_Min_per_Day": parseInt(document.getElementById('Exercise_Min_per_Day').value)
    };

    try {
        // --- Call the Flask API ---
        const response = await fetch('/predict_ivf', {
            method: 'POST',
            // Add credentials to ensure session is sent (if needed for login_required)
            credentials: 'same-origin', 
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(features),
        });

        if (!response.ok) {
            console.error('API Response Not OK:', response);
            const errorData = await response.json();
            throw new Error(errorData.error || `Server responded with status: ${response.status}`);
        }

        const result = await response.json();
        
        // --- Debugging: Log the raw result to console ---
        console.log('Raw API Result:', result);
        
        // --- Display the result ---
        const probability = result.success_probability;
        const predictionText = result.prediction_text;
        const alertClass = probability >= 50 ? 'alert-success' : 'alert-warning';

        resultContainer.innerHTML = `
            <div class="prediction-result-box p-3 rounded">
                <h2 class="display-4 fw-bold text-info">${probability}%</h2>
                <p class="lead mb-2">Predicted Success Chance</p>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${probability}%;" aria-valuenow="${probability}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="alert ${alertClass} mt-3 mb-0">
                    <strong>Outcome Prediction:</strong> ${predictionText}
                </div>
            </div>
            <small class="text-muted mt-2 d-block">
                <i class="fas fa-info-circle me-1"></i>This prediction is based on an AI model analyzing patterns in historical data. It is not a medical guarantee.
            </small>
        `;

    } catch (error) {
        console.error('Prediction Error:', error);
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <strong><i class="fas fa-exclamation-triangle me-2"></i>Error:</strong>
                <p class="mb-0">Could not retrieve prediction. ${error.message}</p>
            </div>
        `;
    } finally {
        // --- Reset button state ---
        predictBtn.disabled = false;
        predictBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Run AI Prediction';
    }
});
</script>
{% endblock %}